window.lingguang||(window.lingguang={});const x={windowMs:1e3,defaultLimit:10,perActionLimit:{"lingguang.storage.setItem":2,"lingguang.storage.getItem":5,"lingguang.storage.removeItem":2,"lingguang.storage.clear":2,"lingguang.data.fetch":1,"lingguang.ai.imageGeneration":1,"lingguang.ai.vllm":1}},U=(()=>{const l=new Map;return{allow(n){const i=Date.now(),o=x.windowMs,t=x.perActionLimit&&x.perActionLimit[n]||x.defaultLimit;let e=l.get(n);e||(e=[],l.set(n,e));const a=i-o;for(;e.length&&e[0]<a;)e.shift();return e.length>=t?!1:(e.push(i),!0)}}})(),R=l=>(n,i,o)=>{if(!U.allow(n)){const t=new Error(`[window.lingguang._call] rate limit exceeded: ${n}`);return t.code="RATE_LIMIT",Promise.reject(t)}return l(n,i,o)},Y=navigator.userAgent||"",B=Y.match(/Leopard\/(\d+\.\d+\.\d+)/);let q=!1;if(B){const n=B[1].split(".").map(Number),i=[1,0,30];(n[0]>i[0]||n[0]===i[0]&&n[1]>i[1]||n[0]===i[0]&&n[1]===i[1]&&n[2]>=i[2])&&(q=!0)}const K=Y.toLowerCase(),W=!/iphone|ipad|ipod|android/.test(K);if(q||W){let l=0;const n=new Map;window.addEventListener("message",o=>{if(o.data&&o.data.type==="CANDYJAR_CALLBACK"){const{callId:t,success:e,result:a,error:s}=o.data,r=t,d=n.get(r);if(!d){console.log("[window.lingguang._call] 未找到对应的回调",r);return}if(n.delete(r),clearTimeout(d.timeoutId),console.log("[window.lingguang._call] clearTimeout",r),e)try{const c=JSON.parse(a.content);d.resolve(c),console.log("[window.lingguang._call] 回调成功",r),console.log("[window.lingguang._call] result",JSON.stringify(a,null,2))}catch(c){console.log("[window.lingguang._call] 回调异常",r,c)}else console.log("[window.lingguang._call] 回调失败",r,s),d.reject(s)}});const i=(o,t,e=3e4)=>{try{const a=`lingguang-call-${Date.now()}-${++l}`;console.log("[window.lingguang._call] start:",a);const s={action:o,payload:JSON.stringify({action:o,params:t,artifactId:window.lingguang._getArtifactId(),artifactVersion:window.lingguang._getArtifactVersion(),debugTraceId:window.trace_id||""}),source:o,extInfo:{}},r={type:"CANDYJAR_CALL",callId:a,method:"FlashApp",action:"remoteSkill",params:s};return console.log("[window.lingguang._call] window.parent.postMessage:",JSON.stringify(r,null,2)),window.parent.postMessage(r,"*"),new Promise((d,c)=>{const g=setTimeout(()=>{n.delete(a),c(new Error(`[window.lingguang._call] timeout: ${o}`))},e);n.set(a,{resolve:d,reject:c,timeoutId:g})})}catch(a){console.log("[window.lingguang._call] 异常",a)}};window.lingguang._call=R(i)}else{const l=(n,i,o=3e4)=>{const t="lingguang_call_"+Date.now()+"_"+Math.random().toString(36).substring(2,9);return console.log(t,n,i),new Promise((e,a)=>{window._candyJarCallbacks||(window._candyJarCallbacks={});const s=w=>{clearTimeout(w),delete window._candyJarCallbacks[t]};let r;window._candyJarCallbacks[t]={resolve:w=>{s(r),e(w)},reject:w=>{s(r),a(w)}},r=setTimeout(()=>{window._candyJarCallbacks&&window._candyJarCallbacks[t]&&window._candyJarCallbacks[t].reject(new Error("lingguang._call 超时"))},o);let d=7;n==="lingguang.data.fetch"&&(d=6);const c={callId:t,click_html_type:d,artifactId:window.lingguang._getArtifactId(),artifactVersion:window.lingguang._getArtifactVersion(),debugTraceId:window.trace_id||"",action:n,params:i},g={scene:"API_INVOKE",query:n,appId:"202508200201904661365",extInfo:c};window.CandyJar.call("HtmlContent","requestInnerHtml",g,function(w){console.log("lingguang._call 请求已发出",w)},function(w){console.error("lingguang._call 调用CandyJar失败",w),window._candyJarCallbacks&&window._candyJarCallbacks[t]&&window._candyJarCallbacks[t].reject(new Error("请求发送失败: "+w))},o)})};window.lingguang._call=R(l)}(function(){let l=0;const n=new Map;window.addEventListener("message",i=>{if(i.data&&i.data.type==="CANDYJAR_CALLBACK"){const{callId:o,success:t,result:e,error:a}=i.data,s=o,r=n.get(s);if(!r){console.log("[window.lingguang._callCandyJar] 未找到对应的回调",s);return}n.delete(s),clearTimeout(r.timeoutId),console.log("[window.lingguang._callCandyJar] clearTimeout",s),t?(r.resolve(e),console.log("[window.lingguang._callCandyJar] 回调成功",s),console.log("[window.lingguang._callCandyJar] result",JSON.stringify(e,null,2))):(console.log("[window.lingguang._callCandyJar] 回调失败",s,a),r.reject(a))}}),window.lingguang._callCandyJar=async(i,o,t,e=3e4)=>{try{const a=`lingguang-candyjar-call-${Date.now()}-${++l}`;console.log("[window.lingguang._callCandyJar] start:",a);const s={type:"CANDYJAR_CALL",callId:a,method:i,action:o,params:t};return console.log("[window.lingguang._callCandyJar] window.parent.postMessage:",JSON.stringify(s,null,2)),window.parent.postMessage(s,"*"),new Promise((r,d)=>{const c=setTimeout(()=>{n.delete(a),d(new Error(`[window.lingguang._callCandyJar] timeout: ${i}.${o}`))},e);n.set(a,{resolve:r,reject:d,timeoutId:c})})}catch(a){return console.log("[window.lingguang._callCandyJar] 异常",a),Promise.reject(a)}}})();window.lingguang._getArtifactId=()=>window.artifactId||"";window.lingguang._getArtifactVersion=()=>window.artifactVersion||"1";window.lingguang._callDataFetch=R((l,n,i=3e4)=>{const o="lingguang_call_"+Date.now()+"_"+Math.random().toString(36).substring(2,9);return console.log("[data.fetch] _callDataFetch start:",o,l,n),new Promise((t,e)=>{window._candyJarCallbacks||(window._candyJarCallbacks={});const a=c=>{clearTimeout(c),delete window._candyJarCallbacks[o]};let s;window._candyJarCallbacks[o]={resolve:c=>{a(s),t(c)},reject:c=>{a(s),e(c)}},s=setTimeout(()=>{window._candyJarCallbacks&&window._candyJarCallbacks[o]&&window._candyJarCallbacks[o].reject(new Error("lingguang._callDataFetch 超时"))},i);const r={callId:o,click_html_type:6,artifactId:window.lingguang._getArtifactId(),artifactVersion:window.lingguang._getArtifactVersion(),debugTraceId:window.trace_id||"",action:l,params:n},d={scene:"API_INVOKE",query:l,appId:"202508200201904661365",extInfo:r};window.CandyJar.call("HtmlContent","requestInnerHtml",d,function(c){console.log("[data.fetch] _callDataFetch 请求已发出",c)},function(c){console.error("[data.fetch] _callDataFetch 调用CandyJar失败",c),window._candyJarCallbacks&&window._candyJarCallbacks[o]&&window._candyJarCallbacks[o].reject(new Error("请求发送失败: "+c))},i)})});window.lingguang.storage={setItem:async(l,n)=>{try{const i=JSON.stringify(n),o=await window.lingguang._call("lingguang.storage.setItem",{key:l,value:i});return console.log("lingguang.storage.setItem",o),o&&o.success?!0:(console.log("lingguang.storage.setItem 失败",o&&o.message||"API call failed"),!1)}catch(i){return console.log("lingguang.storage.setItem 失败",i),!1}},getItem:async l=>{try{const n=await window.lingguang._call("lingguang.storage.getItem",{key:l});return console.log("lingguang.storage.getItem",n),n&&n.success?n.data!==null&&n.data!==void 0?JSON.parse(n.data):null:(console.log("lingguang.storage.getItem 失败",n&&n.message||"API call failed"),null)}catch(n){return console.log("lingguang.storage.getItem 失败",n),null}},removeItem:async l=>{try{const n=await window.lingguang._call("lingguang.storage.removeItem",{key:l});return console.log("lingguang.storage.removeItem",n),n&&n.success?!0:(console.log("lingguang.storage.removeItem 失败",n&&n.message||"API call failed"),!1)}catch(n){return console.log("lingguang.storage.removeItem 失败",n),!1}},clear:async()=>{try{const l=await window.lingguang._call("lingguang.storage.clear",{});return console.log("lingguang.storage.clear",l),l&&l.success?!0:(console.log("lingguang.storage.clear 失败",l&&l.message||"API call failed"),!1)}catch(l){return console.log("lingguang.storage.clear 失败",l),!1}}};window.lingguang.data={fetch:async(l,n)=>{try{const i=new Date,o=`${i.getFullYear()}-${String(i.getMonth()+1).padStart(2,"0")}-${String(i.getDate()).padStart(2,"0")}`,t=await window.lingguang._callDataFetch("lingguang.data.fetch",{query:l,schema:n,currentDate:o});return console.log("lingguang.data.fetch",t),t&&t.success?t.data!==null&&t.data!==void 0?JSON.parse(t.data):null:(console.log("lingguang.data.fetch 失败",t&&t.message||"API call failed"),null)}catch(i){return console.log("lingguang.data.fetch 异常",i),null}}};window.lingguang.ai={imageGeneration:async l=>{try{const n=await window.lingguang._call("lingguang.ai.imageGeneration",{query:l.query,width:l.width,height:l.height});if(console.log("lingguang.ai.imageGeneration",n),n&&n.success)return{url:n.result};throw console.log("lingguang.ai.imageGeneration 失败",n&&n.message||"API call failed"),new Error(n&&n.message||"API call failed")}catch(n){throw console.log("lingguang.ai.imageGeneration 异常",n),new Error(n.errorMessage||"API call failed")}},vllm:async l=>{try{const n=await window.lingguang._call("lingguang.ai.vllm",{content:l.content});if(console.log("lingguang.ai.vllm",n),n&&n.success)return{content:n.result};throw console.log("lingguang.ai.vllm 失败",n&&n.message||"API call failed"),new Error(n&&n.message||"API call failed")}catch(n){throw console.log("lingguang.ai.vllm 异常",n),new Error(n.errorMessage||"API call failed")}}};window.lingguang._filterOptions=(l,n,i={})=>{const o=Object.assign({},i);return n&&Object.keys(n).forEach(t=>{l.includes(t)&&(o[t]=n[t])}),o};window.lingguang.chooseImage=async l=>{console.log("[FLASH APP] lingguang.chooseImage");try{const n=["count","sourceType","sizeType"],i={count:9,sizeType:["original","compressed"],sourceType:["camera","album"],storeToAlbum:!1,highQuality:!0},o=window.lingguang._filterOptions(n,l,i),t=await window.lingguang._callCandyJar("Multimedia","chooseImage",o),e={tempFiles:t.tempFiles||[]};return console.log("[FLASH APP] lingguang.chooseImage 成功",t,e),e}catch(n){throw console.log("[FLASH APP] lingguang.chooseImage 失败",n),new Error(n.errorMessage||"API call failed")}};window.lingguang.takePhoto=async l=>{console.log("[FLASH APP] lingguang.takePhoto");try{const n=["sizeType"],i={count:1,sizeType:["original","compressed"],sourceType:["camera"],storeToAlbum:!1,highQuality:!0},o=window.lingguang._filterOptions(n,l,i),t=await window.lingguang._callCandyJar("Multimedia","chooseImage",o),e={tempFiles:t.tempFiles||[]};return console.log("[FLASH APP] lingguang.takePhoto 成功",t,e),e}catch(n){throw console.log("[FLASH APP] lingguang.takePhoto 失败",n),new Error(n.errorMessage||"API call failed")}};window.lingguang.saveImageToPhotosAlbum=async l=>{console.log("[FLASH APP] lingguang.saveImageToPhotosAlbum");try{const n=["filePath"],i={filePath:"",hideToast:!0},o=window.lingguang._filterOptions(n,l,i),t=await window.lingguang._callCandyJar("Multimedia","saveImageToPhotosAlbum",o);return console.log("[FLASH APP] lingguang.saveImageToPhotosAlbum 成功",t),t}catch(n){throw console.log("[FLASH APP] lingguang.saveImageToPhotosAlbum 失败",n),new Error(n.errorMessage||"API call failed")}};window.lingguang.uploadImage=async l=>{console.log("[FLASH APP] lingguang.uploadImage");try{const n=["filePath","compress"],i={business:"NebulaBiz",compress:4,publicDomain:!0},o=window.lingguang._filterOptions(n,l,i),t=Object.assign({},i);if(o.filePath){const s=o.filePath;if(s.startsWith("file:"))throw console.log("[FLASH APP] lingguang.uploadImage 检测到无效的上传文件路径"),{errorMessage:"上传文件出错"};s.startsWith("data:")?(t.dataType="dataURL",t.data=s):(t.dataType="fileURL",t.data=s)}if(o.compress!==void 0){const s={low:0,medium:1,high:2,none:3,auto:4};t.compress=s[o.compress]!==void 0?s[o.compress]:4}const e=await window.lingguang._callCandyJar("Multimedia","uploadImage",t),a={url:e.publicUrl||""};return console.log("[FLASH APP] lingguang.uploadImage 成功",e,a),a}catch(n){throw console.log("[FLASH APP] lingguang.uploadImage 失败",n),new Error(n.errorMessage||"API call failed")}};window.lingguang.getLocation=async l=>{console.log("[FLASH APP] lingguang.getLocation");try{const n=["poi"],i={requestType:0},o=window.lingguang._filterOptions(n,l,i);o.requestType=l.poi===!0?3:0;const t=await window.lingguang._callCandyJar("LBS","getLocation",o),e=s=>{if(s==null)return 0;const r=Number(s);return isNaN(r)?0:r},a=l.poi===!0?{longitude:e(t.longitude),latitude:e(t.latitude),country:t.country||"",countryCode:t.countryCode||"",province:t.province||"",provinceCode:t.provinceAdcode||"",city:t.city||"",cityCode:t.cityAdcode||"",pois:Array.isArray(t.pois)?t.pois:[]}:{longitude:e(t.longitude),latitude:e(t.latitude)};return console.log("[FLASH APP] lingguang.getLocation 成功",t,a),a}catch(n){throw console.log("[FLASH APP] lingguang.getLocation 失败",n),new Error(n.errorMessage||"API call failed")}};window._candyJarCallbacks||(window._candyJarCallbacks={});window.CandyJar||(window.CandyJar={call:function(l,n,i,o,t,e=2e4){const a="candyJar_"+Date.now()+"_"+Math.random().toString(36).substr(2,9);window._candyJarCallbacks||(window._candyJarCallbacks={}),window._candyJarCallbacks[a]={resolve:d=>{clearTimeout(s),delete window._candyJarCallbacks[a],o&&typeof o=="function"&&o(d)},reject:d=>{clearTimeout(s),delete window._candyJarCallbacks[a],t&&typeof t=="function"&&t(d)}};const s=setTimeout(()=>{window._candyJarCallbacks[a]&&(console.warn("CandyJar 调用超时:",l,n),delete window._candyJarCallbacks[a],t&&typeof t=="function"&&t(new Error("CandyJar call timeout")))},e),r={type:"CANDYJAR_CALL",callId:a,method:l,action:n,params:i};console.log("子iframe向主iframe发送消息:",JSON.stringify(r,null,2)),window.parent.postMessage(r,"*")}},window.addEventListener("message",function(l){if(l.data&&l.data.type==="CANDYJAR_CALLBACK"){const{callId:n,success:i,result:o,error:t}=l.data;if(window._candyJarCallbacks&&window._candyJarCallbacks[n]){const e=window._candyJarCallbacks[n];i?(console.log("CandyJar 调用成功:",n,o),e.resolve(o)):(console.error("CandyJar 调用失败:",n,t),e.reject(new Error(t||"CandyJar call failed")))}else console.warn("未找到对应的回调处理器（可能已经释放） for callId:",n)}if(l.data&&l.data.type==="CANDYJAR_EVENT"){const{eventType:n,eventData:i}=l.data;console.log("子iframe 接收到"+n+"类型的事件转发，数据:"+JSON.stringify(i,null,2));const o=new CustomEvent(n,{detail:i,bubbles:!0,cancelable:!0});i.segmentId!==void 0&&(o.segmentId=i.segmentId),i.sentences!==void 0&&(o.sentences=i.sentences),i.error!==void 0&&(o.error=i.error),i.htmlFragment!==void 0&&(o.htmlFragment=i.htmlFragment),i.action!==void 0&&(o.action=i.action),console.log("iframe - 最终构建的customEvent:",JSON.stringify(o,null,2)),window.document.dispatchEvent(o)}}),console.log("iframe CandyJar 已初始化为 postMessage 通信"));try{document.documentElement&&window.getComputedStyle(document.documentElement).overflow==="hidden"&&(document.documentElement.style.overflow="visible"),document.body&&window.getComputedStyle(document.body).overflow==="hidden"&&(document.body.style.overflow="visible")}catch(l){console.log("移除 overflow 属性失败:",l)}(function(){class l{constructor(){this._startedAtMs=performance.now(),this.destination={_isDestination:!0,connect:function(){}},this.nextId=1,this.sampleRate=44100}get currentTime(){return(performance.now()-this._startedAtMs)/1e3}_postMessage(i){try{const o="candyJar_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),t={type:"CANDYJAR_CALL",callId:o,method:"AudioContext2",action:"event",params:i};return window.parent.postMessage(t,"*"),console.log("AudioContext2: postMessage success: ",JSON.stringify(t,null,2)),o}catch(o){return console.warn("AudioContext2: postMessage error",o),null}}_sendDelayedMessage(i,o){const e=Math.min(o,3e4);e<o&&console.warn("AudioContext2: delay capped at",3e4,"ms (requested:",o+"ms)"),e>0?setTimeout(()=>{this._postMessage(i)},e):this._postMessage(i)}createOscillator(){const i=this.nextId++,o=this;return{id:i,frequency:{value:440,_automation:[],setValueAtTime:function(e,a){this.value=e,this._automation.push({type:"set",value:e,time:a})},linearRampToValueAtTime:function(e,a){this._automation.push({type:"linear",value:e,time:a})},exponentialRampToValueAtTime:function(e,a){this._automation.push({type:"exp",value:e,time:a})}},type:"sine",_connectedToDestination:!1,_started:!1,_stopped:!1,_startAt:null,_stopAt:null,_gainChain:[],_instanceId:`${Date.now()}-${Math.random().toString(36).slice(2)}`,connect:function(e){return e?(e._isGainNode&&(e._upstreamOscillators.push(this),this._gainChain.includes(e)||this._gainChain.push(e)),e._isDestination&&(this._connectedToDestination=!0),this):this},disconnect:function(e){if(!e)return this._connectedToDestination=!1,this._gainChain=[],this;if(e._isGainNode){const a=e._upstreamOscillators.indexOf(this);a>-1&&e._upstreamOscillators.splice(a,1);const s=this._gainChain.indexOf(e);s>-1&&this._gainChain.splice(s,1)}return e._isDestination&&(this._connectedToDestination=!1),this},start:function(e){if(this._started)return;this._started=!0;const a=o.currentTime,s=typeof e=="number"?e:a;if(this._startAt=s,!this._connectedToDestination){console.warn("AudioContext2: oscillator not connected to destination, ignore start");return}this._startPromise=new Promise((u,f)=>{const p=setTimeout(()=>{f(new Error("start timeout"))},1e3);this._startResolve=h=>{clearTimeout(p),u(h)},this._startReject=h=>{clearTimeout(p),f(h)}});const r=.01,d=30;let c=0,g=0,w=!1;if(this.frequency._automation&&Array.isArray(this.frequency._automation))for(const u of this.frequency._automation)typeof u.time=="number"&&u.time>c&&(c=u.time);for(const u of this._gainChain)if(u&&Array.isArray(u._automation))for(const f of u._automation)typeof f.time=="number"&&f.time>c&&(c=f.time),typeof f.value=="number"&&f.value<=r&&(w=!0,f.time>g&&(g=f.time));const I=(w?g:c)-s||0,S=w?I:Math.max(d,I),E=Math.round((S>0?S:d)*1e3),L=[];if(this.frequency._automation)for(const u of this.frequency._automation){const f=u.time-s;f>=0&&L.push({type:u.type,value:u.value,time:f})}const O=[];for(const u of this._gainChain)if(u&&u.gain){const f=[];if(u._automation)for(const p of u._automation){const h=p.time-s;h>=0&&f.push({type:p.type,value:p.value,time:h})}O.push({id:u.id,gain:{value:u.gain.value,automation:f}})}const v=o._postMessage({action:"startOscillator",id:this._instanceId,frequency:{value:this.frequency.value,automation:L},type:this.type,expectedDurationMs:E,gainChain:O});v&&(this._startCallId=v,window._candyJarCallbacks[v]={resolve:this._startResolve,reject:this._startReject}),console.log("AudioContext2: oscillator.start at",s.toFixed(3),"-> startOscillator",this.frequency.value,E+"ms")},stop:function(e){if(this._stopped)return;const a=o.currentTime;this._stopAt=typeof e=="number"?e:a;const s=typeof e=="number"&&e>a;if(!this._connectedToDestination){console.warn("AudioContext2: oscillator not connected to destination, ignore stop");return}(async()=>{try{if(this._startPromise&&await this._startPromise,s){const r=Math.max(0,(e-a)*1e3);setTimeout(()=>{o._postMessage({action:"stopOscillator",id:this._instanceId}),this._stopped=!0,console.log("AudioContext2: 延迟停止 at",e.toFixed(3),"(delay:",r+"ms)")},r)}else o._postMessage({action:"stopOscillator",id:this._instanceId}),this._stopped=!0,console.log("AudioContext2: 立即停止 at",a.toFixed(3));this._startCallId&&delete window._candyJarCallbacks[this._startCallId]}catch(r){console.warn("AudioContext2: start failed, skip stop for",this._instanceId,r),this._startCallId&&delete window._candyJarCallbacks[this._startCallId]}})()}}}createGain(){const o={id:this.nextId++,_isGainNode:!0,_upstreamOscillators:[],_automation:[],gain:{value:1,setValueAtTime:function(t,e){o._automation.push({type:"set",value:t,time:e})},linearRampToValueAtTime:function(t,e){o._automation.push({type:"linear",value:t,time:e})},exponentialRampToValueAtTime:function(t,e){o._automation.push({type:"exp",value:t,time:e})},cancelScheduledValues:function(t){o._automation=o._automation.filter(e=>!(typeof e.time=="number"&&e.time>=t))}},connect:function(t){if(!t)return this;if(t._isDestination)this._upstreamOscillators.forEach(e=>{e._connectedToDestination=!0,e._gainChain.includes(this)||e._gainChain.push(this)});else if(t._isGainNode){const e=new Set(t._upstreamOscillators);this._upstreamOscillators.forEach(a=>e.add(a)),t._upstreamOscillators=Array.from(e),this._upstreamOscillators.forEach(a=>{a._gainChain.includes(t)||a._gainChain.push(t)})}return this},disconnect:function(t){if(!t)return this._upstreamOscillators.forEach(e=>{e._connectedToDestination=!1;const a=e._gainChain.indexOf(this);a>-1&&e._gainChain.splice(a,1)}),this._upstreamOscillators=[],this;if(t._isDestination)this._upstreamOscillators.forEach(e=>{e._connectedToDestination=!1;const a=e._gainChain.indexOf(this);a>-1&&e._gainChain.splice(a,1)});else if(t._isGainNode){const e=t._upstreamOscillators.indexOf(this);e>-1&&t._upstreamOscillators.splice(e,1),this._upstreamOscillators.forEach(a=>{const s=a._gainChain.indexOf(t);s>-1&&a._gainChain.splice(s,1)})}return this}};return o}createBufferSource(){const i=this.nextId++,o=this;return{id:i,buffer:null,loop:!1,loopStart:0,loopEnd:0,playbackRate:{value:1},_connectedToDestination:!1,_started:!1,_stopped:!1,_startAt:null,_stopAt:null,_gainChain:[],_instanceId:`${Date.now()}-${Math.random().toString(36).slice(2)}`,connect:function(e){return e?(e._isGainNode&&(e._upstreamOscillators.push(this),this._gainChain.includes(e)||this._gainChain.push(e)),e._isDestination&&(this._connectedToDestination=!0),this):this},disconnect:function(e){if(!e)return this._connectedToDestination=!1,this._gainChain=[],this;if(e._isGainNode){const a=e._upstreamOscillators.indexOf(this);a>-1&&e._upstreamOscillators.splice(a,1);const s=this._gainChain.indexOf(e);s>-1&&this._gainChain.splice(s,1)}return e._isDestination&&(this._connectedToDestination=!1),this},start:function(e,a,s){if(this._started)return;this._started=!0;const r=o.currentTime,d=typeof e=="number"?e:r;if(this._startAt=d,!this._connectedToDestination){console.warn("AudioContext2: bufferSource not connected to destination, ignore start");return}if(!this.buffer){console.warn("AudioContext2: bufferSource has no buffer, ignore start");return}const c=[];for(const g of this._gainChain)if(g&&g.gain){const w=[];if(g._automation)for(const y of g._automation){const I=y.time-d;I>=0&&w.push({type:y.type,value:y.value,time:I})}c.push({id:g.id,gain:{value:g.gain.value,automation:w}})}o._postMessage({action:"playBufferSource",id:this._instanceId,bufferData:this._getBufferData(),loop:this.loop,loopStart:this.loopStart,loopEnd:this.loopEnd,playbackRate:this.playbackRate.value,offset:a||0,gainChain:c}),console.log("AudioContext2: bufferSource.start at",d.toFixed(3),"-> playBufferSource","loop:",this.loop,"playbackRate:",this.playbackRate.value,"offset:",a||0)},stop:function(e){if(this._stopped)return;const a=o.currentTime;this._stopAt=typeof e=="number"?e:a;const s=typeof e=="number"&&e>a;if(!this._connectedToDestination){console.warn("AudioContext2: bufferSource not connected to destination, ignore stop");return}if(s){const r=Math.max(0,(e-a)*1e3);o._sendDelayedMessage({action:"stopBufferSource",id:this._instanceId},r),setTimeout(()=>{this._stopped=!0},r),console.log("AudioContext2: 延迟停止 at",e.toFixed(3),"(delay:",r+"ms)")}else o._postMessage({action:"stopBufferSource",id:this._instanceId}),this._stopped=!0,console.log("AudioContext2: 立即停止 at",a.toFixed(3))},_getBufferData:function(){if(!this.buffer)return null;const e={sampleRate:this.buffer.sampleRate,length:this.buffer.length,numberOfChannels:this.buffer.numberOfChannels,channels:[]};for(let a=0;a<this.buffer.numberOfChannels;a++){const s=this.buffer.getChannelData(a);e.channels.push(Array.from(s))}return e}}}createBuffer(i,o,t){return{sampleRate:t,length:o,numberOfChannels:i,duration:o/t,_channelData:[],getChannelData:function(a){return this._channelData[a]||(this._channelData[a]=new Float32Array(this.length)),this._channelData[a]},copyFromChannel:function(a,s,r){const d=this.getChannelData(s),c=r||0;for(let g=0;g<a.length&&g+c<d.length;g++)a[g]=d[g+c]},copyToChannel:function(a,s,r){const d=this.getChannelData(s),c=r||0;for(let g=0;g<a.length&&g+c<d.length;g++)d[g+c]=a[g]}}}}window.AudioContext2=l,console.log("AudioContext2 已加载：支持完整的gainchain信息传递和AudioBufferSourceNode")})();function V(l,n=null,i=6e4){return new Promise((o,t)=>{const e="candyJar_"+Date.now()+"_"+Math.random().toString(36).substr(2,9);window._candyJarCallbacks||(window._candyJarCallbacks={}),window._candyJarCallbacks[e]={resolve:c=>{clearTimeout(s),delete window._candyJarCallbacks[e],o(c)},reject:c=>{clearTimeout(s),delete window._candyJarCallbacks[e],t(c)}};const s=setTimeout(()=>{window._candyJarCallbacks[e]&&(console.warn("LLM 调用超时:",e),delete window._candyJarCallbacks[e],t(new Error("LLM call timeout")))},6e4);let r={callId:e,click_html_type:5,debugTraceId:window.trace_id||""};n==="DATA_API_REQUEST"?r.click_html_type=6:n&&(r.system_prompt=n);const d={scene:"API_INVOKE",query:l,appId:"202508200201904661365",extInfo:r};console.log("发送LLM请求:",d),window.CandyJar.call("HtmlContent","requestInnerHtml",d,function(c){console.log("LLM请求发送成功:",c)},function(c){console.error("LLM请求发送失败:",c),window._candyJarCallbacks[e]&&window._candyJarCallbacks[e].reject(new Error("请求发送失败: "+c))},i)})}window.callLLM=V;window.lingguang.callLLM=V;if(!window._callLLMEventListenersInitialized){window._callLLMEventListenersInitialized=!0;const l=new Set([5,6,7]),n=o=>{if(typeof o!="string")return null;const t=o.trim();if(!t)return null;try{return JSON.parse(t)}catch{return null}},i=(o,t,e)=>{if(o===7){const a=n(t);return a!==null?a:{success:!1,raw:t,error:"无法解析响应",extInfo:e}}return o===6?n(t)!==null?{success:!0,data:t,extInfo:e}:{success:!1,raw:t,error:"无法解析数据响应",extInfo:e}:{content:t,extInfo:e}};window.document.addEventListener("CandyJar.HtmlContent.OnHtmlFragmentUpdate",function(o){const t=o.htmlFragment,e=t&&t.extInfo,a=e&&e.click_html_type;if(!t||!e||!l.has(a)){console.log("丢弃非目标类型的 OnHtmlFragmentUpdate 事件");return}if(!o.bubbles){console.log("收到 bubbles=false 的事件，已丢弃");return}const s=e.callId;if(!s){console.warn("OnHtmlFragmentUpdate 缺少 callId，已丢弃");return}if(console.log("子iframe接收到 CandyJar.HtmlContent.OnHtmlFragmentUpdate 事件，事件数据:",JSON.stringify(o,null,2)),t&&t.success){const r=t.content,d=t.hasNext;console.log("处理流式响应 - callId:",s,"hasNext:",d),window._streamingResponses||(window._streamingResponses=new Map),window._streamingResponses.has(s)||window._streamingResponses.set(s,"");const c=window._streamingResponses.get(s);if(r&&window._streamingResponses.set(s,c+r),console.log("累积内容长度:",window._streamingResponses.get(s).length),d===!1){console.log("流式响应结束 - callId:",s);const g=window._streamingResponses.get(s);if(a===6)try{const y=JSON.parse(g);console.log("【DATA_FETCH最终结果】",JSON.stringify(y,null,2))}catch{console.log("【DATA_FETCH最终结果】",g)}window._streamingResponses.delete(s);const w=i(a,g,e);window._candyJarCallbacks&&window._candyJarCallbacks[s]&&window._candyJarCallbacks[s].resolve(w)}}else s&&(console.log("流式响应失败 - callId:",s),window._streamingResponses&&window._streamingResponses.delete(s),window._candyJarCallbacks&&window._candyJarCallbacks[s]&&window._candyJarCallbacks[s].reject(new Error("流式响应失败: "+(t&&t.error||"未知错误"))))})}if(!window._webContainerResizeListenerInitialized){window._webContainerResizeListenerInitialized=!0;let l=null;window.document.addEventListener("CandyJar.WebContainer.Resize",function(n){const i=n.action;if(!(!i||i!=="zoomin"&&i!=="zoomout"))try{if(!document.body)return;if(i==="zoomin"){if(!l){l={overflow:document.body.style.overflow||"",alignItems:document.body.style.alignItems||"",containerPaddingTop:null};const t=Array.from(document.body.children).filter(e=>e.tagName==="DIV");t.length===1&&t[0].id==="container"&&(l.containerPaddingTop=window.getComputedStyle(t[0]).paddingTop)}(document.body.style.alignItems==="flex-start"||!document.body.style.alignItems)&&document.body.style.setProperty("align-items","center","important");const o=Array.from(document.body.children).filter(t=>t.tagName==="DIV");if(o.length===1&&o[0].id==="container"){const t=o[0],e=parseFloat(window.getComputedStyle(document.documentElement).fontSize),a=parseFloat(window.getComputedStyle(t).paddingTop)||0,s=88/e,r=a/e+s;t.style.setProperty("padding-top",`${r}rem`,"important")}}else if(i==="zoomout"&&l){l.alignItems==="flex-start"||l.alignItems===""?document.body.style.setProperty("align-items","flex-start","important"):l.alignItems&&document.body.style.setProperty("align-items",l.alignItems,"important");const o=Array.from(document.body.children).filter(t=>t.tagName==="DIV");o.length===1&&o[0].id==="container"&&l.containerPaddingTop!==null&&o[0].style.setProperty("padding-top",l.containerPaddingTop,"important"),l=null}}catch(o){console.error("样式调整操作失败:",o)}})}(function(){let l=0,n=!1;const i=new URLSearchParams(window.location.search),o=navigator.userAgent.toLowerCase(),t=/iphone|ipad|ipod/.test(o),e=/android/.test(o),a=window.self!==window.top;let s="pc";t?s="ios":e&&(s="android");const r=i.get("fullscreen")==="true",c=i.get("is_in_fr")==="true";function g(){e&&c&&document.addEventListener("contextmenu",function(u){u.preventDefault()},!0)}function w(){if(!a)return;const u=Math.max(document.body.offsetHeight,document.body.scrollHeight,document.documentElement.clientHeight,document.documentElement.scrollHeight,document.documentElement.offsetHeight,100);u!==l&&(window.parent.postMessage({type:"miniapp_resize",height:u,timestamp:Date.now()},"*"),console.log("发送高度信息:",u,"(上次:",l,")"),l=u)}function y(){return console.log("[FLASH APP] getBackgroundColor"),"#ffffff"}function I(){const u=y();console.log("发送背景色:",u),window.parent.postMessage({type:"miniapp_bgcolor",bgcolor:u},"*")}function S(u=5,f=100){let p=0,h=null;function T(){const _=y();if(_===h||p>=u){console.log("样式已稳定，发送背景色:",_,"重试次数:",p),I();return}h=_,p++,setTimeout(T,f)}setTimeout(T,f)}function E(){n||(n=!0,setTimeout(()=>{w(),n=!1},150))}window.addEventListener("message",function(u){u.data.type==="checkHeight"&&w()});function L(){if(!r){console.log("[MiniApp] 当前不是全屏模式，跳过渲染完成通知");return}console.log("[MiniApp] 准备通知父窗口全屏渲染完成"),requestAnimationFrame(()=>{console.log("[MiniApp] 第一帧渲染完成"),requestAnimationFrame(()=>{console.log("[MiniApp] 第二帧渲染完成，发送 flashapp_fullscreen_render_end 消息"),window.parent.postMessage({type:"flashapp_fullscreen_render_end"},"*")})})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",function(){w(),g(),S(5,1e3),L()}):(w(),g(),S(5,1e3),L());const O=new MutationObserver(function(u){let f=!1;u.forEach(function(p){(p.type==="childList"&&(p.addedNodes.length>0||p.removedNodes.length>0)||p.type==="attributes"&&p.attributeName==="style")&&(f=!0)}),f&&E()});function v(){document.body&&document.body instanceof Node?O.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["style"]}):document.readyState==="loading"?document.addEventListener("DOMContentLoaded",v):setTimeout(v,0)}v(),window.addEventListener("error",function(u){parent.postMessage({type:"miniapp_error",error:{message:u.message,filename:u.filename,lineno:u.lineno,colno:u.colno}},"*")}),window.addEventListener("unhandledrejection",function(u){parent.postMessage({type:"miniapp_error",error:{message:"Unhandled Promise Rejection: "+u.reason}},"*")}),s!=="pc"&&a&&!r&&(function(){function u(){const m=navigator.userAgent||navigator.vendor||window.opera;return/iPad|iPhone|iPod/.test(m)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1}let f=!1,p=0,h=5,T=null,_=null;function J(){return T||(T=document.scrollingElement||document.documentElement),T}function $(){if(u()){const m=J();m.style.setProperty("overscroll-behavior","none","important"),m.style.setProperty("-webkit-overflow-scrolling","auto","important"),document.body&&(document.body.style.setProperty("overscroll-behavior","none","important"),document.body.style.setProperty("-webkit-overflow-scrolling","auto","important")),console.log("[嵌套滚动] iOS 设备检测，已禁用回弹效果")}}$();function M(){const m=J();return m.scrollHeight>m.clientHeight}function k(){return M()?J().scrollTop<=2:!1}function N(){if(!M())return!1;const m=J(),{scrollTop:A,scrollHeight:b,clientHeight:D}=m;return A+D>=b-2}function C(m,A){f=m.enabled,window.parent.postMessage({type:"nested_scroll",params:m,reason:A},"*"),console.log(`[嵌套滚动] ${m.enabled?"启用":"禁用"} - 原因: ${A}`,{nestedScrollState:f,params:m,reason:A,timestamp:Date.now()})}let P=!1;document.addEventListener("touchstart",function(m){a&&(p=m.touches[0].clientY,P=!0,console.log("[嵌套滚动] touchstart",{touchStartY:p,nestedScrollState:f}),!f&&M()&&(console.log("[嵌套滚动] touchstart - 提前切换到 enable，确保能接收 touchmove"),C({enabled:!0},"touchstart_preemptive")))},{passive:!0}),document.addEventListener("touchmove",function(m){if(console.log("[嵌套滚动] touchmove 事件触发",{isTracking:P,isInIframe:a,hasTouches:!!m.touches&&m.touches.length>0}),!P||!a){console.log("[嵌套滚动] touchmove - 条件不满足，返回",{isTracking:P,isInIframe:a});return}const b=m.touches[0].clientY-p;if(Math.abs(b)<h){console.log("[嵌套滚动] touchmove - 滑动距离未达阈值",{totalDeltaY:b.toFixed(2),threshold:h});return}const D=b>0,F=b<0;if(D?_="down":F&&(_="up"),!M()){console.log("[嵌套滚动] touchmove - 内容不可滚动，不处理");return}const z=k(),G=N();console.log("[嵌套滚动] touchmove",{totalDeltaY:b.toFixed(2),isScrollingDown:D,isScrollingUp:F,atTop:z,atBottom:G,nestedScrollState:f,lastScrollDirection:_}),D?C({enabled:!0,direction:"down"},"downStart"):F&&C({enabled:!0,direction:"up"},"upStart")},{passive:!0});function H(m){console.log(`[嵌套滚动] ${m}`,{nestedScrollState:f}),f=!1;const A=k();N()?(console.log(`[嵌套滚动] ${m} - 到达底部，立即切换回 disable`),C({enabled:!1,direction:_||"down"},"reachBottom")):A?(console.log(`[嵌套滚动] ${m} - 到达顶部，立即切换回 disable`),C({enabled:!1,direction:_||"up"},"reachTop")):(console.log(`[嵌套滚动] ${m} - 切换回 disable`),C({enabled:!1,direction:_||"down"},m)),P=!1}document.addEventListener("touchend",function(){H("touchend")},{passive:!0}),document.addEventListener("touchcancel",function(){H("touchcancel")},{passive:!0});function j(){if(!f)return;const m=k(),A=N();m?(console.log("[嵌套滚动] checkScrollBoundaries - 到达顶部"),C({enabled:!1,direction:_||"up"},"reachTop")):A&&(console.log("[嵌套滚动] checkScrollBoundaries - 到达底部"),C({enabled:!1,direction:_||"down"},"reachBottom"))}J().addEventListener("scroll",function(){j()},{passive:!0})})()})();